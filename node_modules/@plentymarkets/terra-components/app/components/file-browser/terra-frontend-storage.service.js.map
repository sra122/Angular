{"version":3,"sources":["app/components/file-browser/terra-frontend-storage.service.ts"],"names":[],"mappings":"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","file":"terra-frontend-storage.service.js","sourcesContent":["import { Injectable } from '@angular/core';\nimport { TerraUploadItem } from './model/terra-upload-item';\nimport { TerraUploadQueue } from './model/terra-upload-queue';\nimport { Http } from '@angular/http';\nimport { TerraStorageObjectList } from './model/terra-storage-object-list';\nimport { Observable } from 'rxjs/Observable';\nimport { createS3StorageObject } from './model/s3-storage-object.interface';\nimport { BehaviorSubject } from 'rxjs/BehaviorSubject';\nimport { TerraImageMetadata } from './model/terra-image-metadata.interface';\nimport { TranslationService } from 'angular-l10n';\nimport { isNullOrUndefined } from 'util';\nimport { TerraLoadingSpinnerService } from '../loading-spinner/service/terra-loading-spinner.service';\nimport { TerraBaseMetadataStorageService } from './terra-base-metadata-storage.interface';\n\n@Injectable()\nexport class TerraFrontendStorageService extends TerraBaseMetadataStorageService\n{\n    public isImagePreviewEnabled:boolean = true;\n\n    public name:string;\n\n    public queue:TerraUploadQueue = new TerraUploadQueue('/rest/storage/frontend/file');\n\n    private storageInitialized:boolean = false;\n\n    private storageListSubject:BehaviorSubject<TerraStorageObjectList> = new BehaviorSubject(null);\n\n    private get _storageList():TerraStorageObjectList\n    {\n        return this.storageListSubject.getValue();\n    }\n\n    public get uploadProgress():Observable<number>\n    {\n        return this.queue.progress;\n    }\n\n    private metadataCache:{ [storageKey:string]:TerraImageMetadata } = {};\n\n    constructor(terraLoadingSpinnerService:TerraLoadingSpinnerService, http:Http, translation:TranslationService)\n    {\n        super(terraLoadingSpinnerService, http, '/rest/storage/frontend/file');\n        this.name = translation.translate('terraFileBrowser.myFiles');\n    }\n\n    public getStorageList():Observable<TerraStorageObjectList>\n    {\n        if(!this.storageInitialized)\n        {\n            this.initStorageList();\n        }\n\n        return this.storageListSubject;\n    }\n\n    public createDirectory(path:string):Observable<void>\n    {\n        if(path.charAt(0) === '/')\n        {\n            path = path.substr(1);\n        }\n\n        if(path.charAt(path.length - 1) !== '/')\n        {\n            path += '/';\n        }\n\n        path = this.prepareKey(path);\n\n        this.setAuthorization();\n        let request:Observable<void> = this.mapRequest(\n            this.http.post(\n                this.url + '?key=' + path,\n                null,\n                {\n                    headers: this.headers\n                }\n            )\n        );\n\n        request.subscribe(() =>\n        {\n            this.storageListSubject.next(\n                this._storageList.insertObject(createS3StorageObject(path))\n            );\n        });\n\n        return request;\n    }\n\n    public uploadFiles(files:FileList | Array<File>, path:string = '/'):Array<TerraUploadItem>\n    {\n        if(isNullOrUndefined(files) || files.length <= 0)\n        {\n            return [];\n        }\n\n        let uploadItems:Array<TerraUploadItem> = [];\n\n        /* tslint:disable:prefer-for-of */\n        for(let i:number = 0; i < files.length; i++)\n        {\n            uploadItems.push(this.uploadFile(files[i], path));\n        }\n        /* tslint:enable:prefer-for-of */\n\n        return uploadItems;\n    }\n\n    private uploadFile(file:File, path:string = '/'):TerraUploadItem\n    {\n        if(isNullOrUndefined(file))\n        {\n            return TerraUploadItem.DONE;\n        }\n\n        let item:TerraUploadItem = new TerraUploadItem(file, path, this);\n        item.beforeUpload(() =>\n        {\n            this.storageListSubject.next(\n                this._storageList.insertObject(createS3StorageObject(item.pathname))\n            );\n        });\n\n        item.onSuccess((response:string) =>\n        {\n            let s3Data:any = JSON.parse(response);\n            this.storageListSubject.next(\n                this._storageList.insertObject({\n                    eTag:         s3Data.eTag,\n                    key:          s3Data.key,\n                    lastModified: (new Date()).toISOString(),\n                    size:         file.size,\n                    publicUrl:    s3Data.publicUrl,\n                    storageClass: 'STANDARD'\n                })\n            );\n        });\n\n        item.onError(() =>\n        {\n            this._storageList.root.removeChild(item.pathname);\n            this.storageListSubject.next(this._storageList);\n        });\n\n        item.onCancel(() =>\n        {\n            this._storageList.root.removeChild(item.pathname);\n            this.storageListSubject.next(this._storageList);\n        });\n\n        this.queue.add(item);\n\n        this.queue.startUpload();\n\n        return item;\n    }\n\n    public getMetadata(key:string):Observable<TerraImageMetadata>\n    {\n        if(this.metadataCache.hasOwnProperty(key))\n        {\n            return Observable.from([this.metadataCache[key]]);\n        }\n\n        this.setAuthorization();\n        let request:Observable<any> = this.mapRequest(\n            this.http.get(\n                this.url + '/metadata?key=' + key,\n                {\n                    headers: this.headers\n                }\n            )\n        );\n\n        request.subscribe((metadata:any) =>\n            {\n                this.metadataCache[key] = metadata;\n            },\n            () =>\n            {\n                delete this.metadataCache[key];\n            }\n        );\n\n        return request;\n    }\n\n    public updateMetadata(key:string, metadata:TerraImageMetadata):Observable<any>\n    {\n        this.setAuthorization();\n        let request:Observable<any> = this.mapRequest(\n            this.http.post(\n                this.url + '/metadata',\n                {\n                    key:      key,\n                    metadata: metadata\n                },\n                {\n                    headers: this.headers\n                }\n            )\n        );\n\n        request.subscribe(() =>\n            {\n                this.metadataCache[key] = metadata;\n            },\n            () =>\n            {\n                delete this.metadataCache[key];\n            }\n        );\n\n        return request;\n    }\n\n    public deleteFiles(keyList:Array<string>):Observable<void>\n    {\n        this.setAuthorization();\n        let request:Observable<any> = this.mapRequest(\n            this.http.delete(\n                '/rest/storage/frontend/files?' + keyList.map((key:string):string => 'keyList[]=' + key).join('&'),\n                {\n                    headers: this.headers\n                }\n            )\n        );\n\n        request.subscribe(():void =>\n            {\n                keyList.forEach((key:string):void => this._storageList.root.removeChild(key));\n                this.storageListSubject.next(this._storageList);\n            },\n            ():void =>\n            {\n                this.storageInitialized = false;\n                this.storageListSubject.next(null);\n            }\n        );\n\n        return request;\n    }\n\n    private initStorageList(continuationToken?:string):void\n    {\n        this.storageInitialized = true;\n\n        let url:string = '/rest/storage/frontend/files';\n        if(!isNullOrUndefined(continuationToken))\n        {\n            url += '?continuationToken=' + encodeURIComponent(continuationToken);\n        }\n\n        this.setAuthorization();\n        this.mapRequest(this.http.get(url, {headers: this.headers})).subscribe((results:any):void =>\n            {\n                let storageList:TerraStorageObjectList = this.storageListSubject.getValue() || new TerraStorageObjectList();\n                storageList.insertObjects(results.objects);\n                this.storageListSubject.next(storageList);\n\n                if(results.isTruncated && results.nextContinuationToken.length > 0)\n                {\n                    this.initStorageList(results.nextContinuationToken);\n                }\n            },\n            (err:any):void =>\n            {\n                console.error(err);\n                this.storageInitialized = false;\n                this.storageListSubject.next(null);\n            }\n        );\n    }\n}\n"]}